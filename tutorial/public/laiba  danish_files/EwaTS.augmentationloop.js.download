'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[33],{769:function(y,x,a){function c(Bb,uc){u.Health.instance.recordKpiFailure("AugmentationLoopManagerCreation",uc,!1,!0,{extendedProperties:new Map,durationMs:Date.now()-Bb})}function b(Bb){for(const uc of Bb.values())for(const Pc of uc.annotations)if(!Pc.isInternal&&!Pc.bB)return!0;return!1}function f(Bb,uc){return Array.from(Bb.values()).some(Pc=>Pc.annotations.some(wd=>wd.annotationType===uc))}function r(Bb){return void 0===
Bb?"undefined":`${null===Bb||void 0===Bb?void 0:Bb.Xluid}/${null===Bb||void 0===Bb?void 0:Bb.Xrevid}@${null===Bb||void 0===Bb?void 0:Bb.DocId}`}function d(Bb,uc){Bb=new Map(Bb.map(gc=>[k(gc.annotationType,gc.annotation),{annotationType:gc.annotationType,parentPath:gc.parentPath,annotation:gc.annotation}]));var Pc=new Set(Bb.keys());const wd=new Map(Array.from(uc,gc=>[k(gc.annotationType,gc.annotation),{annotationType:gc.annotationType,parentPath:gc.parentPath,annotation:gc.annotation}]));var Md=new Set(wd.keys());
uc=0;const Nd=[];for(var ec of Md)Bb.has(ec)?(Pc.delete(ec),uc++):(Md=wd.get(ec),Nd.push({annotationType:Md.annotationType,parentPath:Md.parentPath,annotationId:Md.annotation.id}));ec=[];for(const gc of Pc)Pc=Bb.get(gc),ec.push({annotationType:Pc.annotationType,parentPath:Pc.parentPath,annotationId:Pc.annotation.id});return{kCj:uc,Fri:Nd,Tsh:ec}}function k(Bb,uc){switch(Bb){case "AugLoop_Tablelint_TableLintColumnAnnotation":return JSON.stringify({annotationType:"AugLoop_Tablelint_TableLintColumnAnnotation",
columnTitle:uc.columnTitle,columnName:uc.columnName,suggestions:JSON.stringify(uc.suggestions),investigationTelemetry:JSON.stringify(uc.investigationTelemetry),worksheetId:uc.worksheetId,tableName:uc.tableName,tableRange:JSON.stringify(uc.tableRange),tableIdentifier:uc.tableIdentifier,columnIdentifier:uc.columnIdentifier});case "AugLoop_Excel_Session_Protocol_ObserverStatusAnnotation":return JSON.stringify({annotationType:"AugLoop_Excel_Session_Protocol_ObserverStatusAnnotation",isSeedingRequired:uc.isSeedingRequired});
case "AugLoop_ExcelCleanData_ExtraSpacesTableAnnotation":return JSON.stringify({annotationType:"AugLoop_ExcelCleanData_ExtraSpacesTableAnnotation",worksheetId:uc.worksheetId,tableIdentifier:uc.tableIdentifier,tableRange:JSON.stringify(uc.tableRange),boundaryConfidence:uc.boundaryConfidence,tableName:uc.tableName,rangesWithLeading:JSON.stringify(uc.rangesWithLeading),rangesWithTrailing:JSON.stringify(uc.rangesWithTrailing),rangesWithInBetween:JSON.stringify(uc.rangesWithInBetween)});default:return`annotationType: ${Bb}`}}
function t(Bb){Bb=ya.f(Bb);const uc=new gb;let Pc=1;for(var wd=Bb.kh(new Aa.Range(Pc,1,Pc,1,!1,!1));void 0!==wd&&null!==wd&&void 0!==wd.originalText&&""!==wd.originalText;){wd=JSON.parse(wd.originalText);if(!Array.isArray(wd))throw Error(`AugmentationLoopSanityEndToEndTest: Parsing cell A${Pc}, expected the originalText to be a json array`);uc.z7i(wd);Pc++;wd=Bb.kh(new Aa.Range(Pc,1,Pc,1,!1,!1))}return uc}function m(Bb,uc){try{console.log("AugmentationLoopSanityEndToEndTest: starting to read the expected annotations");
const Pc=t(Bb);console.log("AugmentationLoopSanityEndToEndTest: waiting 10000 milliseconds for annotations to be received from websocket");setTimeout(()=>{console.log("AugmentationLoopSanityEndToEndTest: starting to compare the annotation pools");var wd=uc.wvf(sb).map(Mb=>({annotationType:Mb.annotationType,parentPath:Mb.Xda.parentPath,annotation:Mb.Xda.annotation}));const Md=Pc.wvf().map(Mb=>({annotationType:Mb.annotationType,parentPath:Mb.Xda.parentPath,annotation:Mb.Xda.annotation})),{kCj:Nd,Fri:ec,
Tsh:gc}=d(wd,Md);console.log("AugmentationLoopSanityEndToEndTest: logging the comparison results:");wd=`AugmentationLoopSanityEndToEndTest: ${Nd} annotations matched`;console.log(wd);alert(wd);0===ec.length&&0===gc.length?(console.log("AugmentationLoopSanityEndToEndTest: success"),alert("AugmentationLoopSanityEndToEndTest: success")):(0<ec.length&&(console.log(`AugmentationLoopSanityEndToEndTest: ${ec.length} annotations expected but missing: ${JSON.stringify(ec)}`),alert("AugmentationLoopSanityEndToEndTest: failed")),
0<gc.length&&(console.log(`AugmentationLoopSanityEndToEndTest: ${gc.length} annotations unexpected but present: ${JSON.stringify(gc)}`),alert("AugmentationLoopSanityEndToEndTest: failed")))},1E4)}catch(Pc){console.log("AugmentationLoopSanityEndToEndTest: failed "+Pc),alert("AugmentationLoopSanityEndToEndTest: failed "+Pc)}}a.r(x);y={};a.r(y);a.d(y,"AugmentationLoopServerStatus",function(){return Da});a.d(y,"AugLoopRuntimeProxy",function(){return oa});x={};a.r(x);a.d(x,"AugmentationLoopManager",function(){return nc});
var e=a(0),w=a(2),l=a(14),u=a(107),n=a(6),v=a(535),B=a(295),z=a(180),C=a(31),D=a(1243);class J{sendMessage(Bb){l.ULS.sendTraceTag(508965922,306,100,"AL send SDX message");D.a.mwk(Bb)}registerMessageReceivedCallback(Bb){l.ULS.sendTraceTag(508965921,306,50,"AL handle SDX message");D.a.wfk(Bb)}}Object(e.a)(J,"SdxMessageBridge",null,[130]);var W=a(904),N=a(893);class M extends W.a{constructor(){super();this.errorCode=this.isExpected=this.isRetryableError=this.errorType=null;this.H_=Object.assign(new N.a,
{T_:M.getTypeName(),B_:M.getBaseTypes()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelSessionCloseReason"}static getBaseTypes(){return[]}}Object(e.a)(M,"ExcelSessionCloseReason",W.a,[]);class Q extends W.a{constructor(){super();this.reasonDescription=null;this.H_=Object.assign(new N.a,{T_:Q.getTypeName(),B_:Q.getBaseTypes()})}static getTypeName(){return"AugLoop_Session_Protocol_SessionCloseReason"}static getBaseTypes(){return[]}}Object(e.a)(Q,"SessionCloseReason",W.a,[]);var R=
a(158),O=a(1535),U=a(32),K=a(144),F=a(1);class I{constructor(){this.syncDeltaTimeout=this.disableSyncDeltaSending=this.isDeltaGeneratorEnabled=this.powerpoint=this.downloadPolymerBaseUrl=this.inferenceServiceVersion=this.downloadBaseUrl=this.sessionCreationOptions=this.disabledServiceGroups=this.privateMode=this.flights=this.excelServer=this.initSession=this.sessionId=this.releaseFork=this.releaseCustomAudience=this.releaseChannel=this.releaseAudienceGroup=this.uiLanguage=this.appVersion=this.appName=
this.serviceUrl=null}}Object(e.a)(I,"InitializeParameters",null,[]);class P{constructor(){this.documentId=this.userContext=this.enableRemoteExecutionNotification=this.networkMode=this.egress=this.localRegisteredWorkflows=this.enableComplexLocalWorkflows=this.serviceUrl=this.onServerAuthenticationStateChangeCallback=this.onSessionClose=this.onSessionReconnect=this.onSessionDisconnect=this.onSessionConnect=this.flights=this.extensionConfigs=this.docSessionId=null}}Object(e.a)(P,"SessionCreationOptions",
null,[]);class Y{constructor(){this.featureEnabledCallback=null}}Object(e.a)(Y,"SetIsFeatureEnabledCallbackParameters",null,[]);class ea{constructor(){this.changeGateEnabledCallback=null}}Object(e.a)(ea,"SetIsChangeGateEnabledCallbackParameters",null,[]);class Ba{constructor(){this.requestAuthTokenCallback=null}}Object(e.a)(Ba,"SetRequestAuthTokenCallbackParameters",null,[]);class Fa{constructor(){this.sendOTelEvent=null}}Object(e.a)(Fa,"SetSendOTelEventCallbackParameters",null,[]);class za{constructor(){this.handler=
null}}Object(e.a)(za,"SetSessionInitOverrideCallbackParameters",null,[]);class xa{constructor(){this.ulsLogger=null}}Object(e.a)(xa,"SetULSLoggerParameters",null,[]);var fa=a(1100);class V extends W.a{constructor(){super();this.isLargeWorkbookSession=this.workbookLocationUrl=this.activeWorksheetId=this.supportCustomMessages=this.accessTokenTTL=this.accessToken=this.collabStateId=this.collabUserListVersion=this.configurations=this.permissionFlags=this.serverEventVersion=this.workbookMetadataVersion=
this.ecsOperationUrl=this.restUrl=this.ecsId=this.cluster=null;this.H_=Object.assign(new N.a,{T_:V.getTypeName(),B_:V.getBaseTypes()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelServerSessionExtensionConfig"}static getBaseTypes(){return[]}}Object(e.a)(V,"ExcelServerSessionExtensionConfig",W.a,[]);var ba=a(983),la=a(77),Ta=a(97),Ea=a(5),sa=a(903);class Ya{constructor(){this.supportCustomMessages=this.accessTokenTTL=this.accessToken=this.collabStateId=this.userListVersion=this.configurations=
this.permissionFlags=this.serverEventVersion=this.metadataVersion=this.ecsOperationUrl=this.ecsRestUrl=this.ecsSessionId=this.wacCluster=null}}Object(e.a)(Ya,"ExcelServerParameters",null,[]);class bb{constructor(){this.excelServerParameters=null}}Object(e.a)(bb,"ForceReconnectParameters",null,[]);var ra=a(1384),Da;(function(Bb){Bb[Bb.FullyActive=0]="FullyActive";Bb[Bb.ClosedAndWaitingOnlyForNonModelRequiredActivation=1]="ClosedAndWaitingOnlyForNonModelRequiredActivation";Bb[Bb.ActiveForNonModelRequired=
2]="ActiveForNonModelRequired";Bb[Bb.Closed=3]="Closed"})(Da||(Da={}));Object(e.b)("AugmentationLoopServerStatus",Da);Object(Ta.b)(Ea.n,{yk:"singleton"})(Bb=>No(function*(){const uc=Date.now();try{const Pc=oa.bBf();if(!Pc||0===Pc.length)return l.ULS.sendTraceTag(507635341,0,15,"AugLoopRuntimeProxyService.factory: AugLoopCloudALServiceUrl is null or empty"),F.EwaSettings.isChangeGateEnabled("OfficeVSO:8740051_FixedALServicesCheck")&&c(uc,"AugLoopCloudALServiceUrl is null or empty"),null;const wd=yield Ta.a.resolve(Ea.Lb,
Bb);if(F.EwaSettings.isChangeGateEnabled("OfficeVSO:8731848_DisableHPACallsInWebpart")&&wd.ea.th.inWebPart)return l.ULS.sendTraceTag(507527240,0,50,"AugLoopRuntimeProxyService.factory: Disable AugLoop in Web Part"),null;const Md=yield Ta.a.resolve(Ea.ae,Bb),Nd=yield Ta.a.resolve(Ea.be,Bb),ec=yield Ta.a.resolve(Ea.o,Bb);if(F.EwaSettings.isChangeGateEnabled("OfficeVSO:8740051_FixedALServicesCheck")){if(!(wd&&ec&&Md&&Nd))return l.ULS.sendTraceTag(507610115,0,15,"AugLoopRuntimeProxyService.factory: ewaControl or augloopRuntimeManager is null"),
c(uc,"Dependent service is null"),null}else if(!wd||!ec)return l.ULS.sendTraceTag(507610115,0,15,"AugLoopRuntimeProxyService.factory: ewaControl or augloopRuntimeManager is null"),null;const gc=new oa(wd,ec);gc.f$i(Md,Nd);u.Health.instance.recordKpiUsageForAlertableKpi("AugmentationLoopManagerCreation","xlalint",null);return gc}catch(Pc){throw l.ULS.sendTraceTag(507859204,0,15,`AugLoopRuntimeProxyService factory: exception during init: ${Pc}`),F.EwaSettings.isChangeGateEnabled("OfficeVSO:8740051_FixedALServicesCheck")?
c(uc,"Exception"):u.Health.instance.recordKpiFailure("AugmentationLoopManagerCreation","Exception",!1,!0,{extendedProperties:new Map,durationMs:Date.now()-uc}),Pc;}}));class oa{constructor(Bb,uc,Pc){Pc=void 0===Pc?U.a.Tg:Pc;this.$=Bb;this.Oba=uc;this.Bp=Pc;this.J9f=3;this.cyg=3E5;this.uPg=n.AFrameworkApplication.fa.getBooleanFeatureGate("Microsoft.Office.Excel.Augloop.GetAugLoopOrFallbackToken",!1);this.E9=Da.FullyActive;this.xRc=0;this.s_c=null;this.NZ=!1;this.PLa=F.EwaSettings.isChangeGateEnabled("OfficeVSO:8691392_moveWebSocketStatusToRuntimeProxy");
this.Q4a=F.EwaSettings.isChangeGateEnabled("OfficeVSO:8759771_RefactorSessionClosureHandling");this.Yeg=this.$mg=this.Wmg=this.Vmg=null;this.EXf=()=>!1;this.STd=null;this.isFeatureEnabled=wd=>{const Md=n.AFrameworkApplication.fa.la("AugLoop"+wd),Nd=F.EwaSettings.getBooleanFeatureGate(wd,!1),ec=F.EwaSettings.getBooleanFeatureGate("AugLoop"+wd,!1);var gc=F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel."+wd,!1);gc=Nd||ec||gc;const Mb=Md||gc;this.STd.has(wd)||(this.STd.add(wd),l.ULS.shipAssertTag(537170337,
0,!(Md&&!gc),`AugLoopRuntimeProxy.isFeatureEnabled: legacy app setting return true for feature ${wd}, but feature gate return false. This is problem because app setting is depricated and about to be removed`),Mb&&l.ULS.sendTraceTag(537170336,0,50,`AugLoopRuntimeProxy.isFeatureEnabled: feature ${wd} is enabled. legacyAppSettingResult: ${Md}, featureGateWithoutPrefix: ${Nd}, featureGateWithPrefix: ${ec}`));return Mb};this.bBj=()=>{var wd,Md;const Nd=new Map;var ec=F.EwaSettings.isChangeGateEnabled("OfficeVSO:8633499_ExcelAugLoopPropagateAugLoopNamespaceClientFlights");
if(ec){var gc=F.EwaSettings.Kyc("AugLoop");for(const xb of gc){const [Lb,Rc]=xb;Nd.set(Lb,String(Rc))}}gc=F.EwaSettings.Kyc("AugmentationLoopTableLint");for(var Mb of gc){const [xb,Lb]=Mb;Nd.set(xb,String(Lb))}Mb=F.EwaSettings.Kyc("AugmentationLoopInfra");for(var sc of Mb){const [xb,Lb]=sc;Nd.set(xb,String(Lb))}sc=F.EwaSettings.Kyc("CalculatedColumns");for(var xd of sc){const [xb,Lb]=xd;Nd.set(xb,String(Lb))}F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UseChainedCustomResponseSkill",
!1)&&Nd.set("Microsoft.Office.Excel.UseChainedCustomResponseSkill","true");(xd=F.EwaSettings.getStringFeatureGate("Microsoft.Office.Excel.FluxCopilotFeatures",""))&&Nd.set("Microsoft.Office.Excel.FluxCopilotFeatures",xd);(xd=F.EwaSettings.getStringFeatureGate("Microsoft.Office.Excel.FluxOptionSets",""))&&Nd.set("Microsoft.Office.SharedOnline.Augloop.Copilot.OptionSets",xd);F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.FA000000124.CalculatedColumnsHybridWorkflow",!1)&&(Nd.set("Microsoft.Office.Excel.CalculatedColumnsHybridWorkflow",
"true"),Nd.set("Microsoft.Office.Excel.AugmentationLoopTableLintRecognitionPullWorkflows","true"));F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.CalculatedColumnsTLRMultiTableSupport",!1)&&(Nd.set("Microsoft.Office.Excel.TLRMultiTableSupport","true"),Nd.set("Microsoft.Office.Excel.CalculatedColumnsTLRMultiTableSupport","true"));F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.useBetaOptionSets",!1)&&Nd.set("Microsoft.Office.Excel.useBetaOptionSets","true");F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.useBeta2OptionSets",
!1)&&Nd.set("Microsoft.Office.Excel.useBeta2OptionSets","true");F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.FA000000124.OfficeJsCommanding",!1)&&Nd.set("Microsoft.Office.Excel.OfficeJsCommanding","true");(xd=F.EwaSettings.getStringFeatureGate("Microsoft.Office.Excel.FluxSkillOverride",""))&&Nd.set("Microsoft.Office.Excel.FluxSkillOverride",xd);F.EwaSettings.getBooleanFeatureGate(sa.a.a4,!1)&&Nd.set(sa.a.a4,"true");F.EwaSettings.Ra(387)&&Nd.set("EnterpriseDataTypeMipSupport",void 0);
(F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.ExcelOnline.TableLintExperiment",!1)||F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.ExcelOnline.TableLintProdExperiment",!1)||F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",!1))&&Nd.set("LoadAdditionalDataToModel",void 0);F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.DataCleansingTaskPane",!1)&&(Nd.set("DataCleansingSlice0",void 0),Nd.set("LoadAdditionalDataToModel",void 0));F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugloopNoLatency",
!1)&&(Nd.set("AugloopNoLatency",void 0),F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.DataCleansingEnableNewLintersForBetaUsers",!1)||(Nd.set("Microsoft.Office.Excel.AugmentationLoopTableLintSynonymCheck","false"),Nd.set("Microsoft.Office.Excel.AugmentationLoopTableLintFuzzyMatch","false")));F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableLintInvestigationTelemetry",!1)&&Nd.set("TableLintInvestigationTelemetry",void 0);F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TelemetryWorkflowIncludeTextHints",
!1)&&Nd.set("TelemetryWorkflowIncludeTextHints",void 0);F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligenceLogging",!1)&&Nd.set("TableIntelligenceLogging",void 0);F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UseTableSenseML",!1)&&Nd.set("UseTableSenseML",void 0);F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableSenseOnAML",!1)&&Nd.set("TableSenseOnAML",void 0);(null===(Md=null===(wd=this.$)||void 0===wd?void 0:wd.sa)||void 0===Md?0:Md.count)&&
100<this.$.sa.count&&(Nd.set("TableIntelligenceSheetCountThreshold",void 0),l.ULS.sendTraceTag(521151777,306,50,`TableIntelligence max sheet count exceeded. SheetCount: ${this.$.sa.count}`));wd=F.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.ProactiveSuggestionIsPivotableThreshold",-1);-1!==wd&&Nd.set("Microsoft.Office.Excel.ProactiveSuggestionIsPivotableThreshold",wd.toString());!ec&&F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugLoop.FluxMultiLanguageSupport",!1)&&Nd.set("Microsoft.Office.Excel.AugLoop.FluxMultiLanguageSupport",
"true");ec=F.EwaSettings.NHi();for(const xb of ec)Nd.set(xb,"false");return Nd};this.initSessionCallback=()=>{var wd,Md;if(null===(Md=null===(wd=this.$)||void 0===wd?void 0:wd.ea)||void 0===Md?0:Md.sessionId)return l.ULS.sendTraceTag(527708568,0,50,`AugLoopRuntimeProxy.setInitSessionCallback: initSessionCallback called, sessionId is valid (length = ${this.$.ea.sessionId.length}), return resolved promise`),Promise.resolve();l.ULS.sendTraceTag(527708567,0,50,"AugLoopRuntimeProxy.setInitSessionCallback: initSessionCallback called, sessionId is not valid, return promise that will be resolved when session id will be valid again.");
return new Promise(Nd=>{var ec,gc;const Mb=()=>{var sc,xd;(null===(xd=null===(sc=this.$)||void 0===sc?void 0:sc.ea)||void 0===xd?0:xd.sessionId)?(l.ULS.sendTraceTag(527708566,0,50,`AugLoopRuntimeProxy.setInitSessionCallback: sessionId changed callback called with valid session id (length = ${this.$.ea.sessionId.length}), resolve the promise and unregister the callback.`),this.$.ea.pq(Mb),Nd()):l.ULS.sendTraceTag(527708565,0,50,"AugLoopRuntimeProxy.setInitSessionCallback: sessionId changed callback called, but the session id is not valid yet, keep waiting.")};
null===(gc=null===(ec=this.$)||void 0===ec?void 0:ec.ea)||void 0===gc?void 0:gc.uq(Mb)})};this.Mxk=wd=>{var Md;wd.extensionConfigs=[Object(w.a)(new V,{cluster:this.$.ua.MachineCluster,ecsId:this.oIi(),restUrl:this.$.ua.RestActionUrl,ecsOperationUrl:"",workbookMetadataVersion:0,serverEventVersion:0,permissionFlags:0,configurations:0,collabUserListVersion:0,collabStateId:0,accessToken:this.$.ua.AccessToken,accessTokenTTL:this.$.ua.AccessTokenValidTo.toString(),activeWorksheetId:null!==(Md=Object(la.d)(this.$.na))&&
void 0!==Md?Md:void 0,workbookLocationUrl:this.$.ua.DocumentHostInfo.HostEmbeddedViewUrl,isLargeWorkbookSession:this.EXf()})];wd.clientMetadata.documentId=this.$.ua.DocumentHostInfo.ServerDocId;l.ULS.sendTraceTag(509682397,0,50,`AugLoopRuntimeProxy.InitializeAugLoopRuntimeManager: access token TTL ${this.$.ua.AccessTokenValidTo.toString()}, activeWorksheetId ${Object(la.d)(this.$.na)}`);return wd}}getAugLoopRuntimeManager(){return this.Oba}get Nga(){return this.NZ}forceReconnectSession(Bb){F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UpdateNewUserAccessToken",
!1)&&!this.Nga?l.ULS.sendTraceTag(507787421,0,50,`AugmentationLoopRuntimeProxy.forceReconnectSession: web socket is inactive, returning with no-op. Caller: ${Bb}`):(l.ULS.sendTraceTag(507787420,0,50,`AugmentationLoopRuntimeProxy.forceReconnectSession: calling force reconnect. Caller: ${Bb}`),this.Oba.forceReconnectSession(Object(w.a)(new bb,{excelServerParameters:Object(w.a)(new Ya,{wacCluster:this.$.ua.MachineCluster,ecsSessionId:this.$.ea.sessionId,ecsRestUrl:this.$.ua.RestActionUrl,ecsOperationUrl:"",
metadataVersion:0,serverEventVersion:0,permissionFlags:0,configurations:0,userListVersion:0,collabStateId:0,accessToken:this.$.ua.AccessToken,accessTokenTTL:this.$.ua.AccessTokenValidTo.toString()})})).catch(uc=>{l.ULS.sendTraceTag(507798540,0,50,`AugmentationLoopRuntimeProxy.forceReconnectSession: forceReconnectSession promise rejected. Caller: ${Bb}, Error ${uc}`)}))}f$i(Bb,uc){l.ULS.sendTraceTag(537170338,0,50,"augloop: Successfully loaded script");this.STd=new Set;l.ULS.sendTraceTag(522803219,
0,50,"AugLoopRuntimeProxy.InitializeAugLoopRuntimeManager: setIsFeatureEnabledCallback");this.Oba.setIsFeatureEnabledCallback(Object(w.a)(new Y,{featureEnabledCallback:this.isFeatureEnabled}));this.Oba.setIsChangeGateEnabledCallback(Object.assign(new ea,{changeGateEnabledCallback:F.EwaSettings.isChangeGateEnabled}));(this.uPg?Bb:uc)?(Bb=this.EHd(Bb,uc,n.AFrameworkApplication.fa.Xa("AugloopACLPUserDataSignature")),l.ULS.sendTraceTag(522803218,0,50,"AugLoopRuntimeProxy.InitializeAugLoopRuntimeManager: Callback is passed to the augloop runtime which calls the code  when an auth token is required"),
this.Oba.setRequestAuthTokenCallback(Object(w.a)(new Ba,{requestAuthTokenCallback:Bb}))):l.ULS.sendTraceTag(537170335,0,10,"Oauth manager is null");l.ULS.sendTraceTag(522803217,0,50,"AugLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setULSLogger");this.Oba.setULSLogger(Object(w.a)(new xa,{ulsLogger:new v.a}));l.ULS.sendTraceTag(522803216,0,50,"AugLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setSendOTelEventCallback");this.Oba.setSendOTelEventCallback(Object(w.a)(new Fa,
{sendOTelEvent:this.sendOTelEvent}));Bb=this.bBj();l.ULS.sendTraceTag(522803215,0,50,"AugLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setInitSessionCallback");this.Oba.setInitSessionCallback({initSessionCallback:this.initSessionCallback});l.ULS.sendTraceTag(522803214,0,50,"AugLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setSessionInitOverrideCallback");this.Oba.setSessionInitOverrideCallback(Object(w.a)(new za,{handler:this.Mxk}));l.ULS.sendTraceTag(522803213,
0,50,"AugLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.initialize - onSessionClose: getOnCloseMessageCallback ");uc=oa.bBf();this.Oba.initialize(Object(w.a)(new I,{serviceUrl:uc,appName:"Excel",appVersion:n.AFrameworkApplication.fa.Xa("BuildVersion")||"",releaseAudienceGroup:n.AFrameworkApplication.Nh?Object(R.a)(String,n.AFrameworkApplication.Nh.AudienceGroup)||"":"",releaseChannel:null,releaseFork:null,sessionId:this.$.ua.UserSessionId,initSession:!0,flights:this.vZh(Bb),uiLanguage:n.AFrameworkApplication.uiCulture,
excelServer:null,sessionCreationOptions:Object(w.a)(new P,{onSessionConnect:this.xPi(),onSessionDisconnect:this.yPi(),onSessionReconnect:this.zPi(),onSessionClose:this.wPi()})}));this.Oba.setMessageBridge({bridge:new J})}vZh(Bb){return Array.from(Bb.entries()).map(uc=>{var [Pc,wd]=uc;return void 0!==wd?`${Pc}:${wd}`:Pc}).map(uc=>uc+";").join("")}zWk(){return null===this.s_c?void 0:K.a(this.Bp,this.s_c)}VCj(Bb){(void 0===Bb||Bb>this.cyg)&&this.Uok();(Bb=this.xRc>=this.J9f)?l.ULS.sendTraceTag(537170327,
0,15,`AugLoopRuntimeProxy.maxReconnectAttemptsReached: Reached the limit of ${this.J9f} attempts for session creation under interval of ${this.cyg} Ms. Stop trying to reconnect. Time of first attempt in this iterval: ${this.s_c}.`):this.xRc++;return Bb}wPi(){function Bb(uc){if(B.a.instance.AM(n.AFrameworkApplication.accessTokenTtl))return l.ULS.sendTraceTag(508143571,0,15,"AugLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: access token has expired"),!1;if(!uc)return l.ULS.shipAssertTag(508143570,
0,!1,"AugLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: - closeMessage is null"),!0;uc=uc.reason;if(!uc)return l.ULS.shipAssertTag(508160203,0,!1,"AugLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: - closeMessage.closeReason is null"),!0;switch(W.a.getTypeNameFor(uc)){case M.getTypeName():return uc=uc.errorType,l.ULS.shipAssertTag(508143569,0,!(void 0===uc||null===uc),"AugLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: closeReason.errorType is null"),null==uc||2===uc;case Q.getTypeName():uc=uc.reasonDescription;
if("ClientRequested"===uc)return l.ULS.sendTraceTag(508145861,0,15,"AugmentationLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: SessionCloseReason description is ClientRequested"),!1;l.ULS.shipAssertTag(508160202,0,!1,`AugLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: closeReason.reasonDescription is not recognized. reasonDescription: ${uc}`);return!0;default:return l.ULS.shipAssertTag(508160201,0,!1,`AugLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: closeReason.getTypeName() is not recognized. closeReason: ${JSON.stringify(uc)}`),
!0}}return uc=>{const Pc=Bb(uc),wd=this.zWk(),Md=Pc&&!this.VCj(wd);l.ULS.sendTraceTag(508143568,0,50,`AugLoopRuntimeProxy.getOnCloseMessageCallback: ${JSON.stringify({shouldRetryBasedOnCloseMessage:Pc,reconnecting:Md,reconnectsCounter:this.xRc,millisecondsSinceFirstReconnectInInterval:wd,closeMessage:uc})}`);this.Q_i(uc,Md);this.PLa&&(this.NZ=!1)}}Q_i(Bb,uc){var Pc;null===(Pc=this.Yeg)||void 0===Pc?void 0:Pc.call(this,uc,Bb)}xPi(){return(Bb,uc,Pc,wd)=>{var Md;const Nd=uc.substring(uc.lastIndexOf("/")+
1);l.ULS.sendTraceTag(508622662,0,50,`AugLoopRuntimeProxy.getOnConnectMessageCallback: sessionKey ${Nd}.`);this.PLa?this.NZ=!0:null===(Md=this.Vmg)||void 0===Md?void 0:Md.call(this,Bb,uc,Pc,wd)}}yPi(){return Bb=>{var uc;this.PLa?(l.ULS.sendTraceTag(507564314,0,50,`AugmentationLoopRuntimeProxy.getOnDisconnectMessageCallback: previous isWebsocketToAugloopActive=${this.Nga}, error ${Bb}. setting to false.`),this.NZ=!1):null===(uc=this.Wmg)||void 0===uc?void 0:uc.call(this,Bb)}}zPi(){return()=>{var Bb;
this.PLa?(l.ULS.sendTraceTag(507564313,0,50,`AugmentationLoopRuntimeProxy.getOnReconnectMessageCallback: previous isWebsocketToAugloopActive=${this.Nga}. setting to true.`),this.NZ=!0):null===(Bb=this.$mg)||void 0===Bb?void 0:Bb.call(this)}}iDk(Bb){this.Vmg=Bb}jDk(Bb){this.Wmg=Bb}kDk(Bb){this.$mg=Bb}Lyk(Bb){this.Yeg=Bb}aBk(Bb){this.EXf=Bb}Uok(){this.xRc=0;this.s_c=this.Bp.Wh}Twk(Bb){const uc=this;return No(function*(){const Pc=new O.a({authToken:Bb}),wd=new fa.a;wd.message=Pc;yield uc.Oba.submitCustomMessage(wd)})}UCi(Bb,
uc,Pc){const wd=this;return No(function*(){const {fHh:Md,eHh:Nd,xsi:ec,usi:gc}=yield Object(ra.b)(Bb,uc,Pc,wd.Twk.bind(wd)),Mb=Md&&!Nd?Md:ec;if(!Mb)throw Error(gc);return Mb})}EHd(Bb,uc,Pc){Pc=void 0===Pc?"":Pc;return()=>{try{l.ULS.sendTraceTag(527970953,0,50,`AugLoopRuntimeProxy.getAuthTokenDelegate: called with fallbackValue.length: ${Pc.length}.`);if(this.uPg){const wd=n.AFrameworkApplication.fa.getIntFeatureGate("Microsoft.Office.Excel.Augloop.GetTokenTimeoutMs",4E3);return this.UCi(Bb,n.AFrameworkApplication.fa,
wd)}return uc.JD("AugLoop",n.AFrameworkApplication.fa.Xa("AugLoopOAuthResourceUriV2")).then(wd=>{if(wd.IsSuccess)return l.ULS.sendTraceTag(527970952,0,50,"AugLoopRuntimeProxy.getAuthTokenDelegate: successfully fetch token."),wd.Token;l.ULS.sendTraceTag(537170326,0,15,`AugLoopRuntimeProxy.getAuthTokenDelegate: failed to get token, use fallback value (length: ${Pc.length})`);return Pc},()=>{l.ULS.sendTraceTag(537170325,0,15,"AugLoopRuntimeProxy.getAuthTokenDelegate: got rejected promise, use fallback value");
return Pc})}catch(wd){return l.ULS.sendTraceTag(537170324,0,10,"Exception thrown when fetching token"),Promise.resolve(Pc)}}}sendOTelEvent(Bb){z.a.sendOtelEvent(Object(w.a)(new ba.a,{otelEvent:Bb}))}oIi(){const Bb=C.a.kl(this.$.ea.sessionId);return`cluster=${this.$.ua.MachineCluster}&session=${Bb}&usid=${this.$.ua.UserSessionId}`}static bBf(){var Bb;return null!==(Bb=this.VCi())&&void 0!==Bb?Bb:n.AFrameworkApplication.fa.Xa("AugLoopCloudALServiceUrl")}static VCi(){var Bb,uc=Bb||(Bb={});uc[uc.Test=
1]="Test";uc[uc.Int=2]="Int";uc[uc.DogFood=3]="DogFood";uc[uc.Prod=4]="Prod";uc[uc.LocalHost=5]="LocalHost";Object(e.b)("AugLoopEndpointType",Bb);Bb={[Bb.Test]:"https://augloop-test.officeppe.com",[Bb.Int]:"https://augloop-int.officeppe.com",[Bb.DogFood]:"https://augloop-dogfood.officeppe.com",[Bb.Prod]:"https://augloop.office.com",[Bb.LocalHost]:"http://localhost:20080"};uc=n.AFrameworkApplication.fa.getIntFeatureGate("Microsoft.Office.Excel.Augloop.EndpointOverride",0);return Bb[uc]}}Object(e.a)(oa,
"AugLoopRuntimeProxy",null,[]);var Ha=a(179);class ka{}Object(e.a)(ka,"WorkbookCoauthVersion",null,[]);var wa=a(38),Za=a(62);class ab extends Sys.EventArgs{constructor(Bb,uc,Pc,wd){super();this.annotation=Bb;this.V0j=uc;this.parentPath=Pc;this.operationType=wd}}Object(e.a)(ab,"AnnotationEventArgs",Sys.EventArgs,[]);class db{constructor(){this.forceReturnCachedAnnotations=this.stateUpdateHandler=this.handler=this.config=this.annotationType=null}}Object(e.a)(db,"ActivateAnnotationParameters",null,[]);
class mb{constructor(){this.workflow=null}}Object(e.a)(mb,"RegisterLocalWorkflowParameters",null,[]);class Ia{constructor(){this.handler=null}}Object(e.a)(Ia,"SetAnnotationResultCallbackParameters",null,[]);class pa{constructor(){this.operation=null}}Object(e.a)(pa,"SubmitOperationParameters",null,[]);var lb=a(920),ha=a(1331),ua=a(951);class fb extends ua.a{constructor(){super();this.isTriggeredBySyncDelta=null;this.H_=Object.assign(new N.a,{T_:fb.getTypeName(),B_:fb.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_DeleteOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}}
Object(e.a)(fb,"DeleteOperation",ua.a,[]);class Ka extends ua.a{constructor(){super();this.isFocused=!1;this.H_=Object.assign(new N.a,{T_:Ka.getTypeName(),B_:Ka.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_FocusOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}}Object(e.a)(Ka,"FocusOperation",ua.a,[]);var La=a(1110),ib=a(1332);class Yb extends ib.a{constructor(){super();this.prevParentPath=null;this.H_=Object.assign(new N.a,{T_:Yb.getTypeName(),B_:Yb.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_MoveOperation"}static getBaseTypes(){return["AugLoop_Core_OperationWithSiblingContext",
"AugLoop_Core_Operation"]}}Object(e.a)(Yb,"MoveOperation",ib.a,[]);var Wc=a(1257);class Qc extends ua.a{constructor(){super();this.M_=null;this.H_=Object.assign(new N.a,{T_:Qc.getTypeName(),B_:Qc.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_UpdateAnnotationMetaDataOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}}Object(e.a)(Qc,"UpdateAnnotationMetaDataOperation",ua.a,[]);var Wb=a(1333);class Jc extends ua.a{constructor(){super();this.isVisible=!1;this.H_=Object.assign(new N.a,
{T_:Jc.getTypeName(),B_:Jc.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_VisibilityOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}}Object(e.a)(Jc,"VisibilityOperation",ua.a,[]);class ma extends W.a{constructor(){super();this.bridgeId=this.cv=this.messageId=null;this.H_=Object.assign(new N.a,{T_:ma.getTypeName(),B_:ma.getBaseTypes()})}static getTypeName(){return"AugLoop_Session_Protocol_Message"}static getBaseTypes(){return[]}}Object(e.a)(ma,"Message",W.a,[]);class Hc extends ma{constructor(){super();
this.activeWorksheetId=null;this.H_=Object.assign(new N.a,{T_:Hc.getTypeName(),B_:Hc.getBaseTypes()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelKeepAlive"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}}Object(e.a)(Hc,"ExcelKeepAlive",ma,[]);class Kb extends lb.a{constructor(){super();this.isObserverRequired=this.isSeedingRequired=!1;this.H_=Object.assign(new N.a,{T_:Kb.getTypeName(),B_:Kb.getBaseTypes()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ObserverStatusAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}}
Object(e.a)(Kb,"ObserverStatusAnnotation",lb.a,[]);class pc extends lb.a{constructor(){super();this.H_=Object.assign(new N.a,{T_:pc.getTypeName(),B_:pc.getBaseTypes()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_FullSeedingAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}}Object(e.a)(pc,"FullSeedingAnnotation",lb.a,[]);class $b extends ma{constructor(){super();this.parentPath=this.opType=this.seq=this.item=null;this.H_=Object.assign(new N.a,{T_:$b.getTypeName(),
B_:$b.getBaseTypes()})}static getTypeName(){return"AugLoop_Session_Protocol_MicroSyncMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}}Object(e.a)($b,"MicroSyncMessage",ma,[]);class Ib extends W.a{constructor(){super();this.id=null;this.sizeBytes=0;this.dataPointer=this.data=null;this.H_=Object.assign(new N.a,{T_:Ib.getTypeName(),B_:Ib.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_Blob"}static getBaseTypes(){return[]}}Object(e.a)(Ib,"Blob",W.a,[]);class Zb extends Ib{constructor(){super();
this.format=0;this.otherFormat=null;this.size=0;this.isOriginalSize=null;this.H_=Object.assign(new N.a,{T_:Zb.getTypeName(),B_:Zb.getBaseTypes()})}static getTypeName(){return"AugLoop_Image_ImageContent"}static getBaseTypes(){return["AugLoop_Core_Blob"]}}Object(e.a)(Zb,"ImageContent",Ib,[]);class Eb extends W.a{constructor(){super();this.heightPx=this.widthPx=0;this.H_=Object.assign(new N.a,{T_:Eb.getTypeName(),B_:Eb.getBaseTypes()})}static getTypeName(){return"AugLoop_Image_ImageTileMetadata"}static getBaseTypes(){return[]}}
Object(e.a)(Eb,"ImageTileMetadata",W.a,[]);class ob extends Eb{constructor(){super();this.contents=null;this.H_=Object.assign(new N.a,{T_:ob.getTypeName(),B_:ob.getBaseTypes()})}static getTypeName(){return"AugLoop_Image_ImageTile"}static getBaseTypes(){return["AugLoop_Image_ImageTileMetadata"]}}Object(e.a)(ob,"ImageTile",Eb,[]);var Na=a(106),nb;(function(Bb){Bb[Bb.unknown=0]="unknown";Bb[Bb.fatal=1]="fatal";Bb[Bb.yue=2]="tokenExpired";Bb[Bb.Ojl=3]="modelWorkflowNotSupported";Bb[Bb.wjl=4]="largeWorkbooksNotSupported"})(nb||
(nb={}));Object(e.b)("ExcelSessionErrorType",nb);class Hb{constructor(){this.annotations=[]}A7(Bb){this.SJ=Bb;return this}activateAnnotation(Bb){if(this.annotations.includes(Bb))throw Bb=`Annotation from type ${Bb.annotationType} was already activated`,l.ULS.sendTraceTag(521216417,0,10,`AugmentationLoopFeatureRegistrationInfoBuilder.activateAnnotation: ${Bb}`),Error(Bb);this.annotations.push(Bb);return this}B7(Bb){this.featureName=Bb;return this}build(){if(void 0===this.SJ)throw l.ULS.sendTraceTag(521216416,
0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: Close callback is not set"),Error("Close callback is not set");if(!this.featureName)throw l.ULS.sendTraceTag(521216414,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: Feature Name is not set"),Error("Feature Name is not set");return{featureName:this.featureName,SJ:this.SJ,annotations:this.annotations}}}Object(e.a)(Hb,"AugmentationLoopFeatureRegistrationInfoBuilder",null,[117]);var na;(function(Bb){Bb.newAnnotation="New";Bb.validAnnotation=
"Valid";Bb.invalidAnnotation="Invalid"})(na||(na={}));Object(e.b)("AnnotationCallbackType",na);var Gb;(function(Bb){Bb.newAnnotation="New";Bb.validOnArrivalAnnotation="ValidOnArrival";Bb.validAfterSomeTimeAnnotation="ValidAfterSomeTime";Bb.invalidOnCoauthVersionChangedAnnotation="InvalidOnCoauthVersionChanged";Bb.invalidAfterTimeoutAnnotation="InvalidAfterTimeout"})(Gb||(Gb={}));Object(e.b)("AnnotationEventType",Gb);var Xa;(function(Bb){Bb[Bb.beforeAnnotation=0]="beforeAnnotation";Bb[Bb.atAnnotation=
1]="atAnnotation";Bb[Bb.afterAnnotation=2]="afterAnnotation"})(Xa||(Xa={}));Object(e.b)("TimelinePosition",Xa);class Jb{constructor(){this.Swb=new Map;l.ULS.sendTraceTag(520176320,0,50,"AugmentationLoopAnnotationValidatorLogger.constructor: called")}rZe(Bb){this.Swb.has(Bb)||(l.ULS.sendTraceTag(520176291,0,50,`AugmentationLoopAnnotationValidatorLogger.addAnnotationType: ${Bb}`),this.Swb.set(Bb,[]))}rgk(Bb){this.Swb.delete(Bb)&&l.ULS.sendTraceTag(520176290,0,50,`AugmentationLoopAnnotationValidatorLogger.removeAnnotationType: ${Bb}`)}ITj(Bb,
uc){Bb.find(Pc=>Pc.annotationId===uc)||Bb.push({annotationId:uc,GWk:Date.now(),tlc:Gb.newAnnotation})}Vxj(Bb,uc,Pc,wd){l.ULS.sendTraceTag(520176289,0,50,`AugmentationLoopAnnotationValidatorLogger.logLatencyEntry: type: ${Bb}, entry: (${uc.annotationId} ${uc.tlc}) incoming: ${wd}, latency: ${Pc-uc.GWk} ms`)}v4i(Bb,uc,Pc){return(Pc===Gb.validAfterSomeTimeAnnotation||Pc===Gb.validOnArrivalAnnotation)&&(Bb.annotationId===uc||Bb.tlc===Gb.invalidAfterTimeoutAnnotation)}zYj(Bb,uc,Pc,wd){const Md=[],Nd=Date.now();
let ec=Xa.beforeAnnotation;for(const gc of uc){this.v4i(gc,Pc,wd)&&this.Vxj(Bb,gc,Nd,wd);if(gc.annotationId===Pc){gc.tlc=wd;if(wd===Gb.invalidAfterTimeoutAnnotation)return;ec=Xa.atAnnotation}else ec===Xa.atAnnotation&&(ec=Xa.afterAnnotation);uc=wd===Gb.invalidOnCoauthVersionChangedAnnotation?gc.annotationId!==Pc:gc.tlc===Gb.newAnnotation;const Mb=ec===Xa.afterAnnotation;(ec!==Xa.afterAnnotation&&uc||Mb)&&Md.push(gc)}this.Swb.set(Bb,Md)}eKj(Bb,uc,Pc){let wd=this.Swb.get(Bb);wd||(this.rZe(Bb),wd=this.Swb.get(Bb));
Pc===Gb.newAnnotation?this.ITj(wd,uc):this.zYj(Bb,wd,uc,Pc)}}Object(e.a)(Jb,"AugmentationLoopAnnotationValidatorLogger",null,[]);class qb{constructor(Bb,uc){this.toString=()=>JSON.stringify(this);this.annotationId=Bb;this.coauthVersion=uc}}Object(e.a)(qb,"LocalAnnotationId",null,[]);class Db extends wa.a{constructor(Bb){Bb=void 0===Bb?36E5:Bb;super();this.LI=new Map;this.f6=new Map;this.f3a=new Set;this.qye=new Jb;this.svf=Bb;l.ULS.sendTraceTag(523337872,0,50,`AugmentationLoopAnnotationValidator.constructor: annotationExpirationTimeout: ${this.svf} ms`)}dispose(){l.ULS.sendTraceTag(523337871,
0,50,`AugmentationLoopAnnotationValidator.dispose: ${this.getStatus()}`);this.f3a.clear();this.f6.clear();this.LI.clear();super.dispose()}qZe(Bb,uc,Pc){l.ULS.sendTraceTag(521405908,0,50,`AugmentationLoopAnnotationValidator.addAnnotationCallback: annotationType: ${uc}`);this.addHandler(this.i2d(Bb,uc),Pc);this.qye.rZe(uc)}gAg(Bb,uc,Pc){l.ULS.sendTraceTag(521405907,0,50,`AugmentationLoopAnnotationValidator.removeAnnotationCallback: annotationType: ${uc}`);this.removeHandler(this.i2d(Bb,uc),Pc);this.qye.rgk(uc)}iZj(Bb){l.ULS.sendTraceTag(523337870,
0,50,`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: starting, raising CoauthVersionChanged event: ${r(Bb)}`);this.cdj(this.Agb);this.Agb=Bb;this.A9k(this.Agb);this.VSf();l.ULS.sendTraceTag(523337869,0,50,`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: done ${this.getStatus()}`)}Mvf(Bb){if(Bb)try{const Md=JSON.parse(Bb);var uc=Md.coauthVersionDocId,Pc=Md.coauthVersionXluid,wd=Md.coauthVersionXrevId;return{DocId:"undefined"===uc?void 0:uc,Xluid:"undefined"===
Pc?void 0:Pc,Xrevid:"undefined"===wd?void 0:parseInt(wd,10)}}catch(Md){l.ULS.sendTraceTag(523337868,0,10,`AugmentationLoopAnnotationValidator.extractWorkbookCoauthVersion(${Bb}): Exception - ${Md}`)}}aYi(Bb){var uc;const Pc=null===(uc=this.f6.get(r(this.Agb)))||void 0===uc?void 0:uc.vFa;if(!Pc)return[];const wd=r(this.Agb);return[...Pc].map(Md=>this.LI.get(`${new qb(Md,wd)}`)).filter(Md=>Md.annotationType===Bb).map(Md=>Md.sod)}bKj(Bb,uc){const Pc=this.aYi(Bb);l.ULS.sendTraceTag(507795271,0,50,`AugmentationLoopAnnotationValidator.onAnnotationActivation: validAnnotationCallback to be called for ${Pc.length} annotations of type ${Bb}`);
Pc.forEach(wd=>{uc(this,wd)})}aqb(Bb,uc,Pc){Pc=this.Mvf(Pc);void 0!==Pc&&(l.ULS.sendTraceTag(523337867,0,50,`AugmentationLoopAnnotationValidator.onAnnotationReceived: starting ${Bb}: ${uc.operationType}: (annotation id ${uc.annotation.id}) at ${r(Pc)}`),this.Zuh({annotationType:Bb,sod:uc},Pc),this.VSf(),l.ULS.sendTraceTag(523337866,0,50,`AugmentationLoopAnnotationValidator.onAnnotationReceived: done ${this.getStatus()}`))}i2d(Bb,uc){return`${Bb}_${uc}`}getStatus(){var Bb,uc;const Pc=r(this.Agb),wd=
null===(Bb=this.LI)||void 0===Bb?void 0:Bb.size;Bb=null===(uc=this.f3a)||void 0===uc?void 0:uc.size;return`current coauth version: ${Pc}, ${wd} known annotations, ${Bb} coauth versions on hold`}WQc(Bb,uc,Pc,wd){const Md=this.LI.get(`${uc}`);Bb=this.i2d(Bb,Md.annotationType);l.ULS.sendTraceTag(523337865,0,50,`AugmentationLoopAnnotationValidator.raiseAnnotationEvent: ${Pc} raising ${Bb} event (annotation id: ${uc})`);this.raiseEvent(Bb,Md.sod,this);this.qye.eKj(Md.annotationType,`${uc}`,wd)}Klj(Bb,
uc){uc=r(this.Mvf(uc));Bb=`${new qb(Bb,uc)}`;return!this.LI.has(Bb)}Zuh(Bb,uc){var Pc=Bb.sod.annotation.id;const wd=r(uc);Pc=new qb(Pc,wd);const Md=`${Pc}`;this.LI.has(Md)?l.ULS.sendTraceTag(523337864,0,50,`AugmentationLoopAnnotationValidator.addNewAnnotation: ignoring duplicate annotation (annotation id ${Pc})`):(this.LI.set(Md,Bb),this.f6.has(wd)?this.f6.get(wd).vFa.add(Pc.annotationId):this.f6.set(wd,{vFa:new Set([Pc.annotationId]),timestamp:Date.now()}),Bb=this.Agb,uc===Bb||uc&&Bb&&uc.DocId===
Bb.DocId&&uc.Xluid===Bb.Xluid&&uc.Xrevid===Bb.Xrevid?this.WQc("Valid",Pc,"addNewAnnotation","ValidOnArrival"):this.f3a.add(r(uc)))}JAg(Bb){this.LI.delete(`${Bb}`);for(const uc of this.f6.entries()){const [Pc,wd]=uc;if(Pc===Bb.coauthVersion&&wd.vFa.delete(Bb.annotationId))break}}Mhk(){Array.from(this.f6.entries()).filter(Bb=>{[,Bb]=Bb;return 0===Bb.vFa.size}).forEach(Bb=>{[Bb]=Bb;return this.f6.delete(Bb)})}PAg(Bb){this.f3a.delete(Bb)}cdj(Bb){var uc;const Pc=r(Bb);(new Set(null===(uc=this.f6.get(Pc))||
void 0===uc?void 0:uc.vFa)).forEach(wd=>{wd=new qb(wd,Pc);this.WQc("Invalid",wd,"invalidateAnnotations","InvalidOnCoauthVersionChanged");this.JAg(wd)})}A9k(Bb){var uc;Bb=r(Bb);if(this.f3a.has(Bb)){var Pc=null===(uc=this.f6.get(Bb))||void 0===uc?void 0:uc.vFa;uc=(uc=this.f6.get(Bb))?Date.now()-uc.timestamp:0;for(const wd of Pc)Pc=new qb(wd,Bb),this.WQc("Valid",Pc,`validateAnnotations elapsed ${uc} ms`,"ValidAfterSomeTime");this.PAg(Bb)}else l.ULS.sendTraceTag(523337863,0,50,`AugmentationLoopAnnotationValidator.validateAnnotations: ${Bb} has no on-hold annotations associated with it`)}VSf(){var Bb=
Date.now();const uc=[],Pc=[];for(const Md of this.f3a){var wd=this.f6.get(Md);const Nd=Bb-wd.timestamp;if(Nd>this.svf)for(const ec of wd.vFa)wd=new qb(ec,Md),this.WQc("Invalid",wd,`invalidateExpiredAnnotations elapsed ${Nd} ms`,"InvalidAfterTimeout"),uc.push(wd)}for(const Md of uc)this.JAg(Md);for(const Md of this.f3a)Bb=this.f6.get(Md),0===(null===Bb||void 0===Bb?void 0:Bb.vFa.size)&&Pc.push(Md);for(const Md of Pc)this.PAg(Md);this.Mhk()}}Object(e.a)(Db,"AugmentationLoopAnnotationValidator",wa.a,
[116]);class gb{constructor(){this.LI=new Map}aqb(Bb,uc){l.ULS.sendTraceTag(508913554,0,50,`AnnotationPool.onAnnotationReceived: ${JSON.stringify({annotationId:uc.annotation.id,annotationType:Bb,operationType:uc.operationType})}`);this.LI.set(uc.annotation.id,{annotationType:Bb,Xda:uc})}dKj(Bb){const uc=this.LI.delete(Bb);l.ULS.sendTraceTag(508913553,0,50,`AnnotationPool.onAnnotationDeletion: annotationId: ${JSON.stringify({annotationId:Bb,hasBeenInThePool:uc})}`)}Zsb(Bb){Array.from(this.LI.entries()).filter(uc=>
{[,uc]=uc;return uc.annotationType===Bb}).map(uc=>{[uc]=uc;return this.LI.delete(uc)})}OAf(Bb){return this.LI.get(Bb)}z7i(Bb){Bb.forEach(uc=>{const Pc=W.a.getTypeNameFor(uc.body);uc=new ab(uc.body,null,uc.parentPath,1);this.LI.set(uc.annotation.id,{annotationType:Pc,Xda:uc});l.ULS.sendTraceTag(508101586,0,50,`AnnotationPool.importAnnotationItems: ${JSON.stringify({annotationId:uc.annotation.id,annotationType:Pc})}`)})}wvf(Bb){return Bb?Array.from(this.LI.values()).filter(uc=>Bb.includes(uc.annotationType)):
Array.from(this.LI.values())}Jbf(){l.ULS.sendTraceTag(507859419,0,50,`AnnotationPool.clearAnnotations: clearing ${this.LI.size} known annotations`);this.LI.clear()}CMi(){return Array.from(this.LI.values())}size(){return this.LI.size}}Object(e.a)(gb,"AnnotationPool",null,[]);var ya=a(24),Aa=a(26);const sb=["AugLoop_Excel_Session_Protocol_ObserverStatusAnnotation","AugLoop_Tablelint_TableLintColumnAnnotation","AugLoop_ExcelCleanData_ExtraSpacesTableAnnotation"];let nc=class extends wa.a{constructor(Bb,
uc,Pc,wd){Pc=void 0===Pc?new Db(Bb.ua.AugmentationLoopAnnotationExpirationTimeoutInMs):Pc;wd=void 0===wd?U.a.Tg:wd;var Md,Nd;super();this.$=Bb;this.D9=uc;this.xFa=Pc;this.Bp=wd;this.wFa=new gb;this.sza=null;this.isObserverRequired=this.NZ=!1;this.ql=null;this.LUd=!1;this.E9=0;this.qV=new Map;this.Wvf=new Set;this.RGb=[];this.Kqi=new Map([[0,"Unknown"],[1,"Permanent"],[2,"Permanent"],[3,"ModelWorkflowNotSupported"],[4,"ModelWorkflowNotSupported"]]);this.TGb=!1;this.accessTokenExpirationManager=null;
this.d3c=new ka;this.e_a=F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugmentationLoopIncrementalChangesPhase1",!1);this.gnf=F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugmentationLoopSanityEndToEndTest",!1);this.PLa=F.EwaSettings.isChangeGateEnabled("OfficeVSO:8691392_moveWebSocketStatusToRuntimeProxy");this.jWd=F.EwaSettings.isChangeGateEnabled("OfficeVSO:8759994_RemoveFromAnnotationPoolOnUnregisterAnnotation");this.Q4a=F.EwaSettings.isChangeGateEnabled("OfficeVSO:8759771_RefactorSessionClosureHandling");
this.Ifa=()=>this.Q4a?this.D9.E9:this.E9;this.rKj=()=>{l.ULS.sendTraceTag(508380387,0,50,`AugmentationLoopManager.onAugloopSessionConnect: previous isWebsocketToAugloopActive=${this.NZ}. setting to true.`);this.NZ=!0};this.sKj=ec=>{l.ULS.sendTraceTag(508380386,0,50,`AugmentationLoopManager.onAugloopSessionDisconnect: previous isWebsocketToAugloopActive=${this.NZ}, error ${ec}. setting to false.`);this.NZ=!1};this.tKj=()=>{l.ULS.sendTraceTag(508380385,0,50,`AugmentationLoopManager.onAugloopSessionReconnect: previous isWebsocketToAugloopActive=${this.NZ}. setting to true.`);
this.NZ=!0};this.g1=()=>{const ec=this.$.ea.ql.Yu,gc=this.$.isEditMode;ec&&gc?F.EwaSettings.isChangeGateEnabled("OfficeVSO:8708725_move_forceReconnect_to_RuntimeProxy")?this.D9.forceReconnectSession("AugmentationLoopManager.onTokenRefreshed"):this.Ayf("AugmentationLoopManager.onTokenRefreshed"):l.ULS.sendTraceTag(507556740,0,50,`AugmentationLoopManager.onTokenRefreshed: user is inactive or not in edit mode, returning with no-op. isUserActive: ${ec}, isEditMode: ${gc}`)};this.Oi=(ec,gc)=>{gc.rM&&this.$.ea.sessionId&&
(l.ULS.sendTraceTag(537170394,0,50,"AugmentationLoopManager.onSessionIdChanged: Update augmentation loop server on new ECS Session ID"),F.EwaSettings.isChangeGateEnabled("OfficeVSO:8708725_move_forceReconnect_to_RuntimeProxy")?this.D9.forceReconnectSession("AugmentationLoopManager.onSessionIdChanged"):this.Ayf("AugmentationLoopManager.onSessionIdChanged"),this.uVc(this.isObserverRequired,"onSessionIdChanged"))};this.Nga=()=>this.PLa?this.D9.Nga:this.NZ;this.onActiveItemChanged=(ec,gc)=>{ec=Object(la.o)(gc.na)?
Object(la.d)(gc.na):this.activeWorksheetId;gc=F.EwaSettings.isChangeGateEnabled("OfficeVSO:7547289_ALCloseALSessionOnInvalidAccessToken")?this.g$e()&&ec&&ec!==this.activeWorksheetId:ec&&ec!==this.activeWorksheetId;this.activeWorksheetId=ec;gc&&(this.qZd=this.Bp.Wh,l.ULS.sendTraceTag(520677595,0,50,`AugmentationLoopManager.onActiveItemChanged: Submitting keepalive custom message. activeSheetId ${this.activeWorksheetId}`),this.KJg())};this.yMc=(ec,gc)=>{3===this.Ifa()?l.ULS.sendTraceTag(508143578,0,
15,"AugmentationLoopManager.onCloseMessage: Called while augmentation loop server is closed. Avoiding with early return"):(l.ULS.sendTraceTag(508143577,0,50,`AugmentationLoopManager.onCloseMessage called with shouldRetry: ${ec}, isWebsocketToAugloopActive=${this.Nga()}, closeMessage: ${JSON.stringify(gc)}`),this.PLa||(this.NZ=!1),F.EwaSettings.isChangeGateEnabled("OfficeVSO:8740142_ClearAnnotationPoolOnServerClose")&&this.wFa.Jbf(),this.Q4a?(this.uVc(!1,"onCloseMessage"),ec?this.I7b():this.x1i(gc.reason)):
(ec?this.I7b():this.y1i(gc),this.uVc(!1,"onCloseMessage")))};this.y1i=ec=>{var gc,Mb;switch(W.a.getTypeNameFor(ec.reason)){case M.getTypeName():var sc=null===(gc=ec.reason)||void 0===gc?void 0:gc.errorType;ec=null===(Mb=ec.reason)||void 0===Mb?void 0:Mb.errorCode;gc=this.Muf(sc);Mb=nb[sc];this.L9e(gc,ec);switch(sc){case 3:case 4:4===sc&&(this.LUd=!0);this.TGb?(this.E9=2,this.I7b()):(this.E9=1,this.cPa());break;case 1:case 0:this.E9=3,this.cPa()}break;case Q.getTypeName():Mb=sc=ec.reason.reasonDescription;
"ClientRequested"===sc?(this.E9=3,this.cPa()):(this.E9=3,this.cPa(),l.ULS.shipAssertTag(508147337,0,!1,`AugmentationLoopManager.handleNoRetryCloseMessage: closeReason.reasonDescription is not recognized; reasonDescription: ${sc}`));break;default:Mb="unknown",this.E9=3,this.cPa(),l.ULS.shipAssertTag(508160204,0,!1,`AugmentationLoopManager.handleNoRetryCloseMessage: closeMessage.reason type is not recognized; closeReason: ${JSON.stringify(ec.reason)}`)}l.ULS.sendTraceTag(507777541,0,50,`AugmentationLoopManager.handleNoRetryCloseMessage: closeReasonForWidget: ${Mb}`)};
this.$Uh=ec=>{switch(W.a.getTypeNameFor(ec)){case M.getTypeName():return nb[null===ec||void 0===ec?void 0:ec.errorType];case Q.getTypeName():return ec.reasonDescription;default:return"unknown"}};this.x1i=ec=>{l.ULS.sendTraceTag(507777541,0,50,`AugmentationLoopManager.handleNoRetryCloseMessage: closeReasonForWidget: ${this.$Uh(ec)}`);this.cPa();let gc=null;switch(W.a.getTypeNameFor(ec)){case M.getTypeName():var Mb=ec.errorType;const sc=ec.errorCode,xd=this.Muf(Mb);this.L9e(xd,sc);4===Mb&&(this.LUd=
!0);break;case Q.getTypeName():Mb=ec.reasonDescription;"ClientRequested"!==Mb&&(gc=`AugmentationLoopManager.handleNoRetryCloseMessage: closeReason.reasonDescription is not recognized; reasonDescription: ${Mb}`);break;default:gc=`AugmentationLoopManager.handleNoRetryCloseMessage: closeReason type is not recognized; closeReason: ${JSON.stringify(ec)}`}ec=this.uBi(ec);this.D9.E9=ec;2===ec&&this.I7b();null!==gc&&l.ULS.shipAssertTag(508147337,0,!1,gc)};this.Li=(ec,gc)=>{if(gc.Hl)l.ULS.sendTraceTag(520677599,
0,50,"AugmentationLoopManager.onWorkbookClosing: event triggered due to silent reopen. Avoiding event with early return");else if(l.ULS.sendTraceTag(537170381,0,50,`AugmentationLoopManager.onWorkbookClosing: handler invoked
      (IsAppBeforeUnload == ${this.$.z_a}, IsAppUnloading == ${this.$.BU}.`),this.$.z_a||this.$.BU)this.cPa(),this.getAugLoopRuntimeManager().closeSession().catch(Mb=>{l.ULS.sendTraceTag(526406240,0,50,`AugmentationLoopManager.onWorkbookClosing: closeSession promise rejected with error ${Mb}`)})};this.udb=ec=>{l.ULS.sendTraceTag(537170380,0,50,"Annotation Received");if(ec)if(ec.items){var gc=0;({value:gc}=this.sza.gj(W.a.getTypeNameFor(ec),0));0===gc?l.ULS.sendTraceTag(537170377,0,10,"AugmentationLoopManager.annotationCallback: Operation Type not supported "+
W.a.getTypeNameFor(ec)):3===gc?this.a0i(ec):this.q_i(ec,gc)}else l.ULS.sendTraceTag(537170378,0,10,"AugmentationLoopManager.annotationCallback: Operation has no items");else l.ULS.sendTraceTag(537170379,0,10,"AugmentationLoopManager.annotationCallback: Operation is null")};this.AMa=()=>{const ec=K.b(this.Bp,this.qZd);if(F.EwaSettings.isChangeGateEnabled("OfficeVSO:7547289_ALCloseALSessionOnInvalidAccessToken"))var gc=this.g$e()&&this.u3d<=ec;else{gc=this.$.ea.O$;const Mb=this.$.ea.a8;gc=this.u3d<=
ec&&Mb<this.$7a&&!gc}gc?(this.qZd=this.Bp.Wh,l.ULS.sendTraceTag(509682396,0,50,`AugmentationLoopManager.onUserActivityThrottled: Submitting keepalive custom message. secondsSinceLastKeepAlive: ${ec}`),this.KJg()):this.u3d<=ec&&l.ULS.sendTraceTag(520632032,0,50,`AugmentationLoopManager.onUserActivityThrottled: Not submitting keepalive custom message. secondsSinceLastKeepAlive: ${ec}`)};this.wyi=()=>{l.ULS.sendTraceTag(507859418,0,50,"AugmentationLoopManager.fullSeedingAnnotationHandler: Called.");
const ec=this.wFa.CMi();this.wFa.Jbf();for(const gc of ec)this.Pvg(gc)};this.ZIj=(ec,gc)=>{ec=gc.annotation;l.ULS.shipAssertTag(537170373,306,!!ec,"AugmentationLoopManager.ObserverStatusAnnotationHandler: ObserverStatusAnnotation is null.");l.ULS.sendTraceTag(520677594,0,50,`AugmentationLoopManager.observerStatusAnnotationHandler: received ${JSON.stringify(ec)}`);this.isObserverRequired=ec.isSeedingRequired&&ec.isObserverRequired;this.uVc(this.isObserverRequired,"observerStatusAnnotationHandler")};
this.D$b=(ec,gc)=>{var Mb;(null===(Mb=null===gc||void 0===gc?void 0:gc.Uj)||void 0===Mb?0:Mb.WorkbookCoauthVersion)&&this.jZj(gc.Uj.WorkbookCoauthVersion,gc.context)};if(F.EwaSettings.isChangeGateEnabled("OfficeVSO:8740051_FixedALServicesCheck")&&(!Bb||!uc))throw l.ULS.sendTraceTag(507511822,0,15,"AugmentationLoopManager.constructor: EwaControl or AugLoopRuntimeProxy could not be initialized."),Error("AugmentationLoopManager.constructor: EwaControl or AugLoopRuntimeProxy could not be initialized.");
this.qZd=this.Bp.Wh;this.activeWorksheetId=null!==(Md=Object(la.d)(Bb.na))&&void 0!==Md?Md:this.activeWorksheetId;l.ULS.sendTraceTag(520679433,0,50,`AugmentationLoopManager.constructor: setAnnotationResultCallback ${null===(Nd=this.udb)||void 0===Nd?void 0:Nd.name}, activeWorksheetId ${this.activeWorksheetId}`);this.getAugLoopRuntimeManager().setAnnotationResultCallback(Object(w.a)(new Ia,{handler:this.udb}));this.xaj();this.$.Lp(this.Li);this.u3d=this.$.ua.MinimumSecondsBetweenKeepAlivesFromBrowserToAugloop;
this.$7a=60*this.$.ua.UserActiveTimeSinceLastActivityInMinutes;this.$.ea.uq(this.Oi);this.$.Gh.Qm(this.onActiveItemChanged);this.$.sa.Qm(this.onActiveItemChanged);this.$.pa.iI(this.D$b);this.PLa||(this.D9.iDk(this.rKj.bind(this)),this.D9.jDk(this.sKj.bind(this)),this.D9.kDk(this.tKj.bind(this)));this.D9.aBk(this.isLargeWorkbookSession.bind(this));this.D9.Lyk(this.yMc.bind(this));this.O8i();this.Kek();this.gnf&&(this.n3e=new gb,m(Bb,this.n3e));Ea.a.Ha()&&F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UpdateNewUserAccessToken",
!1)?void Ta.a.hj(Ea.a).then(ec=>{this.accessTokenExpirationManager=ec;this.accessTokenExpirationManager.vta(this.g1);l.ULS.sendTraceTag(507556742,0,50,"AugmentationLoopManager.constructor: registered onTokenRefreshed event handler with new access token service")}):F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UpdateNewUserAccessToken",!1)&&this.$.ka.Lh(38,ec=>{this.accessTokenExpirationManager=ec;this.accessTokenExpirationManager.vta(this.g1);l.ULS.sendTraceTag(507556741,0,50,"AugmentationLoopManager.constructor: registered onTokenRefreshed event handler with old access token service")})}getAugLoopRuntimeManager(){return this.D9.getAugLoopRuntimeManager()}O8i(){F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugmentationLoopTableLintRecognitionPullWorkflowsCompare",
!1)&&this.RGb.push("ExcelTableRecognitionReducer");F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugmentationLoopTableLint_SecurityClassificationExcelGridPullWorkflow",!1)&&(F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.FilterOutLegacyLabellingAnnotation",!1)?this.RGb.push("SecurityLabellingReduce"):this.RGb.push("SecurityLabellingMetadataReduce"));l.ULS.sendTraceTag(508683610,0,50,`AugmentationLoopManager.initFilteredOutAnnotations: ${this.RGb.join(",")}`)}Ayf(Bb){F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UpdateNewUserAccessToken",
!1)&&!this.Nga()?l.ULS.sendTraceTag(507787421,0,50,`AugmentationLoopManager.forceReconnectAugloopSession: web socket is inactive, returning with no-op. Caller: ${Bb}`):(l.ULS.sendTraceTag(507787420,0,50,`AugmentationLoopManager.forceReconnectAugloopSession: calling force reconnect. Caller: ${Bb}`),this.getAugLoopRuntimeManager().forceReconnectSession(Object(w.a)(new bb,{excelServerParameters:Object(w.a)(new Ya,{wacCluster:this.$.ua.MachineCluster,ecsSessionId:this.$.ea.sessionId,ecsRestUrl:this.$.ua.RestActionUrl,
ecsOperationUrl:"",metadataVersion:0,serverEventVersion:0,permissionFlags:0,configurations:0,userListVersion:0,collabStateId:0,accessToken:this.$.ua.AccessToken,accessTokenTTL:this.$.ua.AccessTokenValidTo.toString()})})).catch(uc=>{l.ULS.sendTraceTag(507798540,0,50,`AugmentationLoopManager.forceReconnectAugloopSession: forceReconnectSession promise rejected. Caller: ${Bb}, Error ${uc}`)}))}g$e(){const Bb=this.$.ea.O$;return 300>this.$.ea.a8&&!Bb}KJg(){this.Nga()||l.ULS.sendTraceTag(508376342,0,50,
"AugmentationLoopManager.sendExcelKeepAliveMessage: augloop websocket is disconnected, expecting ExcelKeepAlive send to fail");this.getAugLoopRuntimeManager().submitCustomMessage(Object(w.a)(new fa.a,{message:Object(w.a)(new Hc,{activeWorksheetId:this.activeWorksheetId})})).catch(Bb=>{l.ULS.sendTraceTag(526406239,0,10,`AugmentationLoopManager.sendExcelKeepAliveMessage: submitCustomMessage promise rejected with error ${Bb}`)})}e5(){return new Hb}eth(Bb){Bb.pY&&this.$uh(Bb.annotationType,Bb.pY);this.e_a?
Bb.$yd&&this.Wth(Bb.annotationType,Bb.$yd):(Bb.dQa&&this.xFa.qZe("Valid",Bb.annotationType,Bb.dQa),Bb.DDc&&this.xFa.qZe("Invalid",Bb.annotationType,Bb.DDc))}ffe(Bb){Bb.pY&&this.mhk(Bb.annotationType,Bb.pY);this.e_a?Bb.$yd&&this.Egk(Bb.annotationType,Bb.$yd):(Bb.dQa&&this.xFa.gAg("Valid",Bb.annotationType,Bb.dQa),Bb.DDc&&this.xFa.gAg("Invalid",Bb.annotationType,Bb.DDc))}register(Bb){let uc=null,Pc;this.qV.has(Bb.featureName)?(uc=`${Bb.featureName} is already registered. Ignoring new registration.`,
Pc="AlreadyRegisteredFailure"):3===this.Ifa()&&(uc=`Augmentation loop server is permanently closed. Cannot register ${Bb.featureName}.`,Pc="ServerClosedFailure");if(uc)return l.ULS.sendTraceTag(509649306,0,15,`AugmentationLoopManager.register: ${uc}`),Pc;l.ULS.sendTraceTag(509686223,0,50,`AugmentationLoopManager.register: Registering ${Bb.featureName}`);this.qV.set(Bb.featureName,Bb);Bb.annotations.forEach(wd=>this.ezg(Bb.featureName,wd));return"Success"}unregister(Bb){const uc=this.qV.get(Bb);if(!uc)return l.ULS.sendTraceTag(509686220,
0,15,`AugmentationLoopManager.unregister: feature ${Bb} is not registered`),"UnregisteredFeatureFailure";l.ULS.sendTraceTag(509686221,0,50,`AugmentationLoopManager.unregister: unregister ${Bb}`);this.jWd?(this.qV.delete(Bb),uc.annotations.forEach(Pc=>{this.P0g(Pc)})):(uc.annotations.forEach(Pc=>this.DLb(Pc)),uc.annotations.forEach(Pc=>{this.ffe(Pc)}),this.qV.delete(Bb));this.Q4a||(this.TGb=b(this.qV));return"Success"}Muf(Bb){var uc;return null!==(uc=this.Kqi.get(Bb))&&void 0!==uc?uc:"Unknown"}hbk(){switch(this.Ifa()){case 0:this.qV.forEach(Bb=>
{Bb.annotations.forEach(uc=>{this.activateAnnotation(uc)})});break;case 2:this.qV.forEach(Bb=>{Bb.annotations.filter(uc=>!uc.bB).forEach(uc=>{this.activateAnnotation(uc)})});break;case 1:case 3:l.ULS.shipAssertTag(509661458,0,!1,`AugmentationLoopManager.reactivateAnnotationsBasedOnModelSupported: Called while augmentation loop server is ${Da[this.Ifa()]}`)}}isLargeWorkbookSession(){const Bb=F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugLoop.ExcelIncreaseCopilotCellLimit",!1)&&2===
this.Ifa()&&!this.LUd&&this.qV.has("CopilotWarmupAnnotation");Bb&&l.ULS.sendTraceTag(507529025,0,50,"AugmentationLoopManager.isLargeWorkbookSession: init LargeWorkbook session.");return Bb}uBi(Bb){if(W.a.getTypeNameFor(Bb)===M.getTypeName())switch(Bb.errorType){case 3:case 4:return b(this.qV)?2:1;default:return 3}else return 3}AKc(Bb){return`New_${Bb}`}g2d(Bb){return`Delete_${Bb}`}$uh(Bb,uc){l.ULS.sendTraceTag(520679429,0,50,`AugmentationLoopManager.addNewAnnotationCallback: annotationType: ${Bb}, handler: ${null===
uc||void 0===uc?void 0:uc.name}`);this.addHandler(this.AKc(Bb),uc)}mhk(Bb,uc){l.ULS.sendTraceTag(509686219,0,50,`AugmentationLoopManager.removeNewAnnotationCallback: annotationType: ${Bb}, handler: ${null===uc||void 0===uc?void 0:uc.name}`);this.removeHandler(this.AKc(Bb),uc)}Wth(Bb,uc){l.ULS.sendTraceTag(508913552,0,50,`AugmentationLoopManager.addDeleteAnnotationCallback: annotationType: ${Bb}, handler: ${null===uc||void 0===uc?void 0:uc.name}`);this.addHandler(this.g2d(Bb),uc)}Egk(Bb,uc){l.ULS.sendTraceTag(508913551,
0,50,`AugmentationLoopManager.removeDeleteAnnotationCallback: annotationType: ${Bb}, handler: ${null===uc||void 0===uc?void 0:uc.name}`);this.removeHandler(this.g2d(Bb),uc)}Cth(Bb){l.ULS.sendTraceTag(520679427,0,50,"AugmentationLoopManager.addCoauthVersionChangedCallback");this.addHandler("CoauthVersionChanged",Bb)}ezg(Bb,uc){if(0!==this.Ifa()&&uc.bB)return l.ULS.sendTraceTag(509650462,0,50,`AugmentationLoopManager.registerAnnotationInternal: Augmentation loop server does not support model workflow. Cannot activate ${uc.annotationType}.`),
!1;if(uc.isInternal){if([1,3].includes(this.Ifa()))return!1}else this.Q4a||this.TGb||(this.TGb=!uc.bB),this.eRk(!uc.bB),this.oUg();this.activateAnnotation(Object.assign({},uc,{featureName:Bb}));this.eth(uc);return!0}xpa(Bb,uc){let Pc=null,wd;const Md=this.qV.get(Bb);Md?Md.annotations.some(Nd=>uc.annotationType===Nd.annotationType)?(Pc=`Annotation ${uc.annotationType} is already registered for feature ${Bb}.`,wd="AlreadyRegisteredFailure"):3===this.Ifa()&&(Pc=`Augmentation loop server is permanently closed. Cannot activate ${uc.annotationType}.`,
wd="ServerClosedFailure"):(Pc=`Feature ${Bb} is not registered. Cannot register ${uc.annotationType}.`,wd="UnregisteredFeatureFailure");if(Pc)return l.ULS.sendTraceTag(509682975,0,15,`AugmentationLoopManager.registerAnnotation: ${Pc}`),wd;l.ULS.sendTraceTag(509686218,0,50,`AugmentationLoopManager.registerAnnotation: Registering annotation ${uc.annotationType} for feature ${Bb}.`);this.ezg(Bb,uc)&&Md.annotations.push(uc);return"Success"}E1k(Bb){const uc=this.qV.get("AutoPolicy");if(uc){l.ULS.sendTraceTag(509367457,
0,50,`AugmentationLoopManager.unregisterAnnotation: Unregister annotation ${Bb} for feature ${"AutoPolicy"}.`);var Pc=uc.annotations.findIndex(wd=>wd.annotationType===Bb);if(-1!==Pc){const wd=uc.annotations[Pc];this.jWd?(uc.annotations.splice(Pc,1),this.P0g(wd)):(this.DLb(wd),this.ffe(wd),uc.annotations.splice(Pc,1));this.Q4a||(this.TGb=b(this.qV))}}else l.ULS.sendTraceTag(509367458,0,15,"AugmentationLoopManager.unregisterAnnotation: Feature AutoPolicy is not registered.")}P0g(Bb){this.DLb(Bb);this.ffe(Bb);
this.jWd&&(f(this.qV,Bb.annotationType)||this.wFa.Zsb(Bb.annotationType))}I7b(){l.ULS.sendTraceTag(509661457,0,50,"AugmentationLoopManager.startNewALSession: Starting new AL session.");this.getAugLoopRuntimeManager().startNewSession();this.oUg();this.hbk()}eRk(Bb){l.ULS.shipAssertTag(509650461,0,3!==this.Ifa(),"AugmentationLoopManager.startNewALSessionIfNecessary: Called while augmentation loop server is closed permanently.");1===this.Ifa()&&Bb&&(this.Q4a?this.D9.E9=2:this.E9=2,this.I7b())}aBj(Bb,
uc){return`${Bb}->${uc}`}activateAnnotation(Bb){Bb.iij?l.ULS.sendTraceTag(508347874,0,50,`AugmentationLoopManager.activateAnnotation: Skipping activation of annotation type: ${Bb.annotationType} because it's a fake annotation.`):(l.ULS.sendTraceTag(520679425,0,50,`AugmentationLoopManager.activateAnnotation: Activating annotation type: ${Bb.annotationType}.`),this.Nga()||l.ULS.sendTraceTag(508376341,0,15,`AugmentationLoopManager.activateAnnotation: augloop websocket is disconnected, expecting '${Bb.annotationType}' activation to fail`),
this.getAugLoopRuntimeManager().activateAnnotation(Object(w.a)(new db,{annotationType:Bb.annotationType,stateUpdateHandler:Bb.Xgl})).then(uc=>{if(uc){var Pc=this.aBj(Bb.featureName,Bb.annotationType);!this.e_a&&this.Wvf.has(Pc)&&this.xFa.bKj(Bb.annotationType,Bb.dQa);this.Wvf.add(Pc);Pc=this.qV.get(Bb.featureName);(Pc=null===Pc||void 0===Pc?void 0:Pc.annotations.find(wd=>wd.annotationType===Bb.annotationType))?Pc.m3e=uc.token:l.ULS.sendTraceTag(507885148,0,15,`AugmentationLoopManager.activateAnnotation: annotationInfoInRegistry is undefined for feature ${Bb.featureName}, annotationType ${Bb.annotationType}`);
Bb.zDh&&Bb.zDh(Bb.annotationType,uc)}else l.ULS.sendTraceTag(520677603,0,10,"AugmentationLoopManager.activateAnnotation: ActivateAnnotationsResult is null");return null}).catch(uc=>{l.ULS.sendTraceTag(520677602,0,50,`AugmentationLoopManager.activateAnnotation: activateAnnotation promise rejected with error ${uc}`)}))}DLb(Bb){Bb.m3e?this.getAugLoopRuntimeManager().releaseAnnotation({token:Bb.m3e}).then(uc=>{uc||l.ULS.sendTraceTag(507893770,0,15,`AugmentationLoopManager.deactivateAnnotation: ReleaseAnnotationResult is False for annotation ${Bb.annotationType}, featureName: ${Bb.featureName}`);
Bb.ADh&&Bb.ADh(Bb.annotationType,uc);return null}).catch(uc=>{l.ULS.sendTraceTag(507893769,0,15,`AugmentationLoopManager.deactivateAnnotation: releaseAnnotation promise rejected with error ${uc}, featureName: ${Bb.featureName}`)}):l.ULS.sendTraceTag(507893768,0,15,`AugmentationLoopManager.deactivateAnnotation: annotationActivationToken is not available for annotation ${Bb.annotationType}, featureName: ${Bb.featureName}`)}submitOperation(Bb){if(!Bb)return l.ULS.shipAssertTag(537170387,0,!1,"AugmentationLoopManager.submitOperation: operation is null"),
"InvalidParameterFailure";const uc=W.a.getTypeNameFor(Bb);l.ULS.sendTraceTag(537170386,0,50,`AugmentationLoopManager.submitOperation: submitting operation of type '${uc}'`);this.Nga()||l.ULS.sendTraceTag(508376340,0,50,`AugmentationLoopManager.submitOperation: augloop websocket is disconnected, expecting send '${uc}' to fail`);this.getAugLoopRuntimeManager().submitOperation(Object(w.a)(new pa,{operation:Bb}));return"Success"}twb(Bb){if(!Bb)return l.ULS.shipAssertTag(537170385,0,!1,"AugmentationLoopManager.submitOperationSignal: signal is null"),
"InvalidParameterFailure";const uc=Object.getTypeName(Bb);l.ULS.sendTraceTag(537170384,0,50,`AugmentationLoopManager.submitOperationSignal: submitting operation signal of type '${uc}'`);if(!this.Nga())return l.ULS.sendTraceTag(508380384,0,15,`AugmentationLoopManager.submitOperationSignal: could not submit signal of type '${uc}' because augloop websocket is disconnected`),"DisconnectedFromAugloop";this.getAugLoopRuntimeManager().submitOperation(Object(w.a)(new pa,{operation:Object(w.a)(new Wc.a,{parentPath:["Signal",
Object.getTypeName(Bb)],items:[Object(w.a)(new La.a,{body:Bb})]})}));return"Success"}registerLocalWorkflow(Bb){if(!Bb)return l.ULS.shipAssertTag(537170383,0,!1,"AugmentationLoopManager.registerLocalWorkflow: workflow is null"),"InvalidParameterFailure";l.ULS.sendTraceTag(537170382,0,50,`AugmentationLoopManager.registerLocalWorkflow: registering local workflow '${Bb.id}'`);this.getAugLoopRuntimeManager().registerLocalWorkflow(Object(w.a)(new mb,{workflow:Bb}));return"Success"}H7k(Bb,uc,Pc,wd){Bb=Object(w.a)(new ob,
{heightPx:wd,widthPx:Pc,contents:[Object(w.a)(new Zb,{id:uc+".0",format:2,size:3,sizeBytes:Bb.length,data:Bb})]});uc=Object(w.a)(new La.a,{id:uc,body:Bb});uc=Object(w.a)(new $b,{item:uc});l.ULS.sendTraceTag(520677600,0,50,"AugmentationLoopManager.uploadImage: submitting custom message");this.getAugLoopRuntimeManager().submitCustomMessage(Object(w.a)(new fa.a,{message:uc})).catch(Md=>{l.ULS.sendTraceTag(526406241,0,50,`AugmentationLoopManager.uploadImage: submitCustomMessage promise rejected with error ${Md}`);
return"UnknownFailure"})}dispose(){this.$&&this.$.ea&&this.$.ea.pq(this.Oi);this.$&&this.$.Gh&&(this.$.Gh.hn(this.onActiveItemChanged),this.$.sa.hn(this.onActiveItemChanged));this.$&&this.$.pa&&this.$.pa.MK(this.D$b);F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UpdateNewUserAccessToken",!1)&&this.accessTokenExpirationManager&&(this.accessTokenExpirationManager.ntb(this.g1),l.ULS.sendTraceTag(507556739,0,50,"AugmentationLoopManager.dispose: unregistered onTokenRefreshed event handler."));
this.cPa();super.dispose()}oUg(){this.ql||(this.ql=this.$.ea.ql,this.ql.jFa(this.AMa))}cPa(){this.ql&&(this.ql.HNa(this.AMa),this.ql=null)}L9e(Bb,uc){for(const Pc of this.qV.values())if(0===this.Ifa()||!Pc.annotations.every(wd=>wd.bB))try{Pc.SJ(Bb,uc)}catch(wd){l.ULS.sendTraceTag(509674971,0,10,`AugmentationLoopManager.callAugloopCloseCallbacks: caught exception from ${Pc.featureName} close callback with message: ${wd.message}`)}}xaj(){this.sza=new Na.a;this.sza.ga(ha.a.getTypeName(),1);this.sza.ga(Wb.a.getTypeName(),
2);this.sza.ga(Yb.getTypeName(),5);this.sza.ga(fb.getTypeName(),3);this.sza.ga(Jc.getTypeName(),7);this.sza.ga(Ka.getTypeName(),6);this.sza.ga(Qc.getTypeName(),4)}q_i(Bb,uc){1!==uc&&l.ULS.sendTraceTag(508904538,0,15,`AugmentationLoopManager.handleAddOrUpdateOperation: handling operation of type ${uc}`);for(const wd of Bb.items){if(!wd){l.ULS.sendTraceTag(537170376,0,10,"AugmentationLoopManager.handleAddOrUpdateOperation: Error in item");continue}if(!wd.body||!this.isAnnotation(wd.body)){l.ULS.sendTraceTag(537170375,
0,10,"AugmentationLoopManager.handleAddOrUpdateOperation: Body is either null or not an annotation.");continue}var Pc=wd.source;if(this.RGb.includes(Pc)){l.ULS.sendTraceTag(520677597,0,100,`AugmentationLoopManager.handleAddOrUpdateOperation: Filtered out annotation of owner ${Pc}`);continue}Pc=W.a.getTypeNameFor(wd.body);if(!Pc){l.ULS.sendTraceTag(523329624,0,50,"AugmentationLoopManager.handleAddOrUpdateOperation: annotationType is null");continue}const Md=wd.body;if(!Md){l.ULS.sendTraceTag(523329623,
0,50,"AugmentationLoopManager.handleAddOrUpdateOperation: annotation is null");continue}l.ULS.sendTraceTag(576271178,0,50,`AugmentationLoopManager.handleAddOrUpdateOperation: Triggering Event handler for Annotation ${Pc}. ParentRevId: ${Bb.parentRevId}`);const Nd=new ab(Md,null,Bb.parentPath,uc);this.gnf&&this.n3e.aqb(Pc,Nd);this.e_a?(this.wFa.OAf(Md.id)&&l.ULS.sendTraceTag(508678295,0,50,`AugmentationLoopManager.handleAddOrUpdateOperation: received annotation whose Id is already in the pool, annotationType: ${Pc}, id: ${Md.id}, operationType: ${uc}`),
this.wFa.aqb(Pc,Nd),this.raiseEvent(this.AKc(Pc),Nd,this),l.ULS.sendTraceTag(508678338,0,100,`AugmentationLoopManager.handleAddOrUpdateOperation: raising newAnnotation event (annotation type: ${Pc})`)):(this.xFa.Klj(Nd.annotation.id,Bb.parentRevId)&&(this.raiseEvent(this.AKc(Pc),Nd,this),l.ULS.sendTraceTag(520677596,0,100,`AugmentationLoopManager.handleAddOrUpdateOperation: raising newAnnotation event (annotation type: ${Pc})`)),this.xFa.aqb(Pc,Nd,Bb.parentRevId))}}isAnnotation(Bb){return W.a.getTypeNameFor(Bb)===
lb.a.getTypeName()||0<=Array.indexOf(W.a.getBaseTypesFor(Bb),lb.a.getTypeName())}a0i(Bb){for(const uc of Bb.items)if(!uc)l.ULS.sendTraceTag(508913550,0,10,"AugmentationLoopManager.handleDeleteOperation: Error in item");else if(!uc.id)l.ULS.sendTraceTag(508913549,0,10,"AugmentationLoopManager.handleDeleteOperation: Item had no id");else if(this.e_a){const Pc=this.wFa.OAf(uc.id);Pc&&(Bb.parentPath!==Pc.Xda.parentPath&&(l.ULS.sendTraceTag(508875280,0,15,`AugmentationLoopManager.handleDeleteOperation: parentPath of the operation [${Bb.parentPath}] is different from the parentPath of the stored annotation [${Pc.Xda.parentPath}]`),
Pc.Xda.parentPath=Bb.parentPath),this.Pvg(Pc),this.wFa.dKj(uc.id))}}Kek(){this.register(this.e5().B7("ALManagerInternalAnnotations").A7(()=>{}).activateAnnotation({annotationType:Kb.getTypeName(),bB:!1,pY:this.ZIj,isInternal:!0}).build());F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",!1)&&this.xpa("ALManagerInternalAnnotations",{annotationType:"AugLoop_UnitTelemetry_UnitTelemetryAggregatedAnnotation",bB:!0});F.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TablelintComparison",
!1)&&this.xpa("ALManagerInternalAnnotations",{annotationType:"AugLoop_Excel_ExcelComparisonAnnotation",bB:!0});this.e_a&&this.xpa("ALManagerInternalAnnotations",{annotationType:pc.getTypeName(),bB:!1,pY:this.wyi,isInternal:!0})}Pvg(Bb){l.ULS.sendTraceTag(507859417,0,100,`AugmentationLoopManager.raiseAnnotationDeletedEvent: raising deleteAnnotation event (annotation type: ${Bb.annotationType})`);const uc=new ab(Bb.Xda.annotation,Bb.Xda.V0j,Bb.Xda.parentPath,3);this.raiseEvent(this.g2d(Bb.annotationType),
uc,this)}uVc(Bb,uc){if(this.$.isEditMode&&this.$.ea.sessionId){l.ULS.sendTraceTag(509371223,0,50,`AugmentationLoopManager.sendObserverRequiredNotification: isObserverRequired: ${this.isObserverRequired}, caller: ${void 0===uc?"":uc}`);uc=this.$.pa.ta;const Pc=uc.Za(1,null);Pc.isObserverRequired=Bb;Za.h(uc,"ObserverRequiredNotification",Pc,null,null,null,null,0)}}submitCustomMessage(Bb){return this.getAugLoopRuntimeManager().submitCustomMessage(Bb)}jZj(Bb,uc){if(this.d3c.DocId!==Bb.DocId||this.d3c.Xluid!==
Bb.Xluid&&this.d3c.Xrevid!==Bb.Xrevid)this.d3c=Bb,this.raiseEvent("CoauthVersionChanged",{coauthVersion:Bb,userContext:uc},this),this.e_a||this.xFa.iZj(Bb)}};nc=Object(Ha.__decorate)([Object(Ta.d)(Ea.p),Object(Ha.__param)(0,Object(Ea.Lb)()),Object(Ha.__param)(1,Object(Ea.n)())],nc);Object(e.a)(nc,"AugmentationLoopManager",wa.a,[40,2]);String(y);String(x);window.___1708742503356_closurehack=y;window.___1708742503356_closurehack=x}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaTS.augmentationloop.js.map/b7c4e1ca3217f5f38baaa8e038eba8f6/EwaTS.augmentationloop.js.map